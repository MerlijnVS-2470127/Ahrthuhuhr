<!DOCTYPE html>
<html lang="en">
  <head>
    <%- include('../partials/FS_Standard_Head'); %>
    <title>Group chat: <%= group.name %></title>
    <script>
      // hier kan vs code een syntax error geven, maar dat komt doordat het ejs binnen <script> niet herkend
      window.__CHAT = {
        groupId: "<%= groupId %>",
        groupName: "<%= group.name %>",
        groupDescr: "<%= group.description %>",
        currentUser: "<%= currentUser %>",
        lastFetch: <%= messages.length ? messages[messages.length - 1].created_at : 0 %>
      };
      window.eventsInfo = <%- JSON.stringify(events) %>;
      window.usersInfo = <%- JSON.stringify(userInfo) %>;
      window.pollsData = <%- JSON.stringify(polls) %>;
    </script>
    <script src="/js/FS_Groupchat.js" defer></script>

    <link rel="stylesheet" href="/css/FS_Groupchat.css" />
  </head>

  <body>
    <header><%- include('../partials/FS_Header'); %></header>
    <div class="main-content-wrapper">
      <div class="page_header">Group: <%= group.name %></div>
      <div class="main_div">
        <div class="chat_division" id="chat-panel">
          <section id="chat" class="chat">
            <!-- prettier-ignore -->
            <div id="messages" class="messages" aria-live="polite">
              <% 
                function findSenderByMsgName(msgName) {
                  if (!msgName) return null;
                  for (const u of userInfo) {
                    if (u.email === msgName) return u;
                    if (u.username === msgName) return u;
                  }
                  return null;
                }

                function roleClass(role) {
                  if (!role) return "role-member";
                  const r = String(role).toLowerCase();
                  if (r === "lurker") return "role-lurker";
                  if (r === "member") return "role-member";
                  if (r === "admin") return "role-admin";
                  if (r === "owner") return "role-owner";
                  return "role-member";
                }
              %>

              <% messages.forEach(function(msg) { 
                  const sender = findSenderByMsgName(msg.user_name);
                  const displayName = sender ? sender.username : (msg.user_name || "Anonymous");
                  const rclass = roleClass(sender ? sender.role : null);
              %>
                <div class="message" data-id="<%= msg.id %>">
                  <div class="meta">
                    <strong class="<%= rclass %>"><%= displayName %></strong> â€”
                    <%= new Date(msg.created_at).toLocaleString() %>
                  </div>
                  <div class="content"><%= msg.content %></div>
                </div>
              <% }) %>
            </div>

            <form id="composer" class="composer" onsubmit="return false;">
              <input
                type="text"
                id="content"
                placeholder="Type a message..."
                autocomplete="off"
              />
              <button id="sendBtn">Send</button>
            </form>
          </section>
        </div>

        <div class="chat_division" id="side-panel">
          <section id="chat" class="chat">
            <div class="btn-group w-100 mb-2" role="tablist">
              <button class="btn btn-outline-primary active" id="tab-events">
                Events
              </button>
              <button class="btn btn-outline-primary" id="tab-info">
                Info
              </button>
              <button class="btn btn-outline-primary" id="tab-polls">
                Polls
              </button>
            </div>

            <h1 class="" id="sp-title"></h1>
            <div class="mb-2 sp-description">
              <small
                class="badge bg-light text-muted"
                id="sp-description"
                style="font-size: 18px; text-decoration: none"
              >
              </small>
            </div>

            <div class="sp-contents" id="sp-contents"></div>
          </section>
        </div>
      </div>
    </div>
    <footer><%- include('../partials/FS_Footer'); %></footer>
  </body>
</html>
